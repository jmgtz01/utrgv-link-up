{% extends "base.html" %}
{% load static %}

{% block content %}
<h1>Available Computers</h1>
{% if is_admin %}
{# Staff-only edit controls #}
<div class="toolbar" style="margin:.5rem 0 1rem; display:flex; gap:.5rem;">
  <button id="toggle-edit" class="btn btn-sm">Edit mode: Off</button>
  <small style="opacity:.8">Click a marker to cycle status. In Edit mode, drag to reposition (saves to server).</small>
</div>
{% endif %}
{% if user_active %}
{# Active reservation banner for current user #}
<div class="alert alert-info d-flex align-items-center justify-content-between" style="gap:.5rem;">
  <div>
    You have an active reservation: <strong>{{ user_active.resource_name }}</strong>
    ({{ user_active.resource_type }}) until
    <span id="active-res-end" data-end="{{ user_active.end }}">{{ user_active.end }}</span>
  </div>
  <div>
    <button id="cancel-reservation" class="btn btn-danger btn-sm">Cancel reservation</button>
  </div>
</div>
{% endif %}
<style>
  .map-wrap{
    position:relative; width:100%; max-width:1400px; margin:1rem 0 2rem;
    border:1px solid #333; border-radius:16px;
    background:url("{% static map_img %}") center/cover no-repeat;
    aspect-ratio: 1/1; /* change if your map isn't square */
  }
  .marker{
    position:absolute; width:36px; height:36px; transform:translate(-50%,-50%);
    display:grid; place-items:center; border-radius:10px; background:rgba(0,0,0,.35);
    backdrop-filter:blur(2px); cursor:pointer; user-select:none;
    left: calc(var(--x) * 1%); top: calc(var(--y) * 1%);
    transition: box-shadow .1s ease, transform .06s ease;
  }
  .marker img{ width:32px; height:32px; object-fit:contain; pointer-events:none; }
  .marker.editing{ box-shadow:0 0 0 3px rgba(255,255,255,.25) inset; cursor:grab; }
  .label{
    position:absolute; top:32px; left:50%; transform:translateX(-50%);
    font-size:.85rem; white-space:nowrap; text-shadow:0 1px 2px #000;
    pointer-events:none;
  }
  .click-tooltip {
    position: fixed;
    visibility: hidden;
    opacity: 0;
    padding: 6px 12px;
    background: #282828;
    color: white;
    border-radius: 6px;
    border: 1px solid #555;
    transform: translate(-50%, -120%);
    pointer-events: none;
    transition: opacity 0.2s ease, visibility 0.2s ease;
    font-size: 0.9rem;
    z-index: 1080;
    white-space: nowrap;
  }
  .click-tooltip.show { visibility: visible; opacity: 1; }
</style>

<div class="map-wrap" id="map">
  {# Tooltip anchor and all markers #}
  <div id="click-tooltip" class="click-tooltip"></div>
  {% for c in computers %}
    <div class="marker"
         data-id="{{ c.id }}" data-type="computer" data-status="{{ c.status }}"
         data-is-mine="{{ c.is_mine|yesno:'true,false' }}" style="--x: {{ c.x|floatformat:-2 }}; --y: {{ c.y|floatformat:-2 }};"
         title="{{ c.name }} ({{ c.status|title }})">
      <img src="{% static c.icon %}" alt="{{ c.status }}">
      <div class="label">{{ c.name }}</div>
    </div>
  {% endfor %}

  {% for r in rooms %}
    <div class="marker"
         data-id="{{ r.id }}" data-type="room" data-status="{{ r.status }}"
         data-is-mine="{{ r.is_mine|yesno:'true,false' }}" style="--x: {{ r.x|floatformat:-2 }}; --y: {{ r.y|floatformat:-2 }};"
         title="{{ r.name }} ({{ r.status|title }})">
      <img src="{% static r.icon %}" alt="{{ r.status }}">
      <div class="label">{{ r.name }}</div>
    </div>
  {% endfor %}
</div>

<!-- Unified modal for login/reservation -->
<div class="modal fade" id="reservation-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="reservation-modal-title">Reserve</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="reservation-modal-body">Loading...</div>
      <div class="modal-footer border-secondary" id="reservation-modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
// Delay execution until after Bootstrap JS is available
window.addEventListener('load', () => {
(function(){
  // --- Page-level setup ---
  const isAdmin = {{ is_admin|yesno:"true,false" }};
  const isAuthenticated = {{ is_authenticated|yesno:"true,false" }};

  const tooltip = document.getElementById('click-tooltip');
  let tooltipTimer = null;

  const ICONS = {
    computer: {
      order: ["available","reserved","occupied","repair"],
      urls: {
        available: "{% static 'img/available.png' %}",
        reserved:  "{% static 'img/reserved.png' %}",
        occupied:  "{% static 'img/lock.png' %}",
        repair:    "{% static 'img/bsod.png' %}",
      }
    },
    room: {
      order: ["available","reserved","occupied","out_of_order"],
      urls: {
        available:    "{% static 'img/sravailable.png' %}",
        reserved:     "{% static 'img/srreserved.png' %}",
        occupied:     "{% static 'img/sroccupied.png' %}",
        out_of_order: "{% static 'img/sroutoforder.png' %}",
      }
    }
  };

  const SAVE_URL = "{% url 'link_up:update_position' %}";
  const STATUS_URL = "{% url 'link_up:update_status' %}";
  const SLOTS_URL = "{% url 'link_up:available_slots' %}";
  const RESERVE_URL = "{% url 'link_up:create_reservation' %}";
  const LOGIN_URL = "{% url 'login' %}";
  const CANCEL_URL = "{% url 'link_up:cancel_reservation' %}";

  const modalEl = document.getElementById('reservation-modal');
  const modalTitle = document.getElementById('reservation-modal-title');
  const modalBody = document.getElementById('reservation-modal-body');
  const modalFooter = document.getElementById('reservation-modal-footer');
  let modalInstance = null;

  // Grab CSRF from cookies for all POSTs
  function getCookie(name){
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  // Main map and control handles
  const map = document.getElementById('map');
  const toggleBtn = document.getElementById('toggle-edit');
  const cancelBtn = document.getElementById('cancel-reservation');
  let editMode = false;
  let dragging = null, pointerId = null;

  function showTooltip(text, e) {
    if (tooltipTimer) {
      clearTimeout(tooltipTimer);
    }
    tooltip.textContent = text;
    tooltip.style.left = e.clientX + 'px';
    tooltip.style.top = e.clientY + 'px';
    tooltip.classList.add('show');
    tooltipTimer = setTimeout(() => {
      tooltip.classList.remove('show');
    }, 2000);
  }

  // Format ISO times into human-readable ranges
  function formatRange(startIso, endIso){
    const start = new Date(startIso);
    const end = new Date(endIso);
    const opts = { hour: 'numeric', minute: '2-digit' };
    return `${start.toLocaleTimeString([], opts)} - ${end.toLocaleTimeString([], opts)}`;
  }

  // --- Modal: login inline ---
  // Lets guests authenticate without leaving this page
  function showLoginModal(targetLabel){
    modalTitle.textContent = `Log in to reserve ${targetLabel}`;
    modalBody.innerHTML = `
      <div class="alert alert-info">Please log in to reserve this spot.</div>
      <div class="mb-3">
        <label class="form-label">Username</label>
        <input class="form-control" name="username" autocomplete="username">
      </div>
      <div class="mb-3">
        <label class="form-label">Password</label>
        <input class="form-control" name="password" type="password" autocomplete="current-password">
      </div>
      <div class="text-danger small d-none" id="login-error"></div>
    `;
    modalFooter.innerHTML = `
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      <button type="button" class="btn btn-primary" id="login-submit">Log In</button>
    `;
    if(!modalInstance){
      modalInstance = new bootstrap.Modal(modalEl);
    }
    modalInstance.show();

    modalFooter.querySelector('#login-submit').onclick = async () => {
      const username = modalBody.querySelector('input[name="username"]').value.trim();
      const password = modalBody.querySelector('input[name="password"]').value;
      const err = modalBody.querySelector('#login-error');
      err.classList.add('d-none');
      try{
        const resp = await fetch(LOGIN_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken,
            "X-Requested-With": "XMLHttpRequest"
          },
          body: JSON.stringify({ username, password })
        });
        if(resp.ok){
          location.reload();
        }else{
          const data = await resp.json().catch(() => ({}));
          err.textContent = data.error || "Login failed. Please try again.";
          err.classList.remove('d-none');
        }
      }catch(ex){
        err.textContent = "Network error.";
        err.classList.remove('d-none');
      }
    };
  }

  // --- Modal: pick slot, optionally cancel current ---
  // Shows available slots and lets user cancel an active booking to proceed
  async function openReservationModal(marker){
    const type = marker.dataset.type;
    const name = marker.title || marker.querySelector('.label')?.textContent || 'this spot';
    modalTitle.textContent = `Reserve ${name}`;
    modalBody.innerHTML = `<p class="text-muted mb-2">Loading available times...</p>`;
    modalFooter.innerHTML = `<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>`;
    if(!modalInstance){
      modalInstance = new bootstrap.Modal(modalEl);
    }
    modalInstance.show();

    let data;
    try{
      const resp = await fetch(SLOTS_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken
        },
        body: JSON.stringify({ type, id: marker.dataset.id })
      });
      if(!resp.ok){
        modalBody.innerHTML = `<div class="alert alert-danger">Unable to load slots.</div>`;
        return;
      }
      data = await resp.json();
    }catch(ex){
      modalBody.innerHTML = `<div class="alert alert-danger">Unable to load slots.</div>`;
      return;
    }

    const hasOtherActive = data.user_active && !(data.user_active.resource_type === type && String(data.user_active.resource_id) === marker.dataset.id);
    if (hasOtherActive){
      const message = `You already have an active reservation until ${formatRange(data.user_active.start, data.user_active.end).split(' - ')[1]}. Cancel it to reserve another slot.`;
      modalBody.innerHTML = `
        <div class="alert alert-warning mb-3">${message}</div>
        <button type="button" class="btn btn-danger" id="modal-cancel-res">Cancel current reservation</button>
      `;
      modalFooter.innerHTML = `<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>`;
      const btn = modalBody.querySelector('#modal-cancel-res');
      btn.onclick = async () => {
        btn.disabled = true;
        try{
          const resp = await fetch(CANCEL_URL, {
            method: "POST",
            headers: { "Content-Type":"application/json", "X-CSRFToken": csrftoken },
            body: JSON.stringify({})
          });
          if(resp.ok){
            location.reload();
          }else{
            btn.disabled = false;
            modalBody.innerHTML += `<div class="text-danger mt-2">Cancel failed. Please reload.</div>`;
          }
        }catch(ex){
          btn.disabled = false;
          modalBody.innerHTML += `<div class="text-danger mt-2">Network error. Please reload.</div>`;
        }
      };
      return;
    }

    // Filter out only open slots for today
    const availableSlots = data.slots.filter(s => s.available);
    if (!availableSlots.length){
      modalBody.innerHTML = `<div class="alert alert-secondary">No slots remaining today.</div>`;
      return;
    }

    const list = availableSlots.map((slot, idx) => {
      const label = formatRange(slot.start, slot.end);
      return `<div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="slot-choice" id="slot-${idx}" value="${slot.start}" ${idx===0 ? 'checked' : ''}>
                <label class="form-check-label" for="slot-${idx}">${label}</label>
              </div>`;
    }).join('');

    const nowAction = data.current_available ? `<button type="button" class="btn btn-success btn-sm mb-3" id="reserve-now-btn">Reserve now (until end of hour)</button>` : '';
    modalBody.innerHTML = `
      ${nowAction}
      <p class="mb-2">Select a 1-hour slot (today):</p>
      ${list}
      <div class="text-danger small d-none" id="reserve-error"></div>
    `;
    modalFooter.innerHTML = `
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      <button type="button" class="btn btn-primary" id="reserve-submit">Reserve</button>
    `;

    const nowBtn = modalBody.querySelector('#reserve-now-btn');
    if (nowBtn){
      // Book remainder of current hour instantly
      nowBtn.onclick = async () => {
        nowBtn.disabled = true;
        try{
          const resp = await fetch(RESERVE_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrftoken
            },
            body: JSON.stringify({ type, id: marker.dataset.id, reserve_now: true })
          });
          if(resp.ok){
            location.reload();
          }else{
            nowBtn.disabled = false;
            const d = await resp.text();
            modalBody.querySelector('#reserve-error').classList.remove('d-none');
            modalBody.querySelector('#reserve-error').textContent = d || "Could not reserve now.";
          }
        }catch(ex){
          nowBtn.disabled = false;
          modalBody.querySelector('#reserve-error').classList.remove('d-none');
          modalBody.querySelector('#reserve-error').textContent = "Network error.";
        }
      };
    }

    modalFooter.querySelector('#reserve-submit').onclick = async () => {
      const chosen = modalBody.querySelector('input[name="slot-choice"]:checked');
      if(!chosen) return;
      const err = modalBody.querySelector('#reserve-error');
      err.classList.add('d-none');
      try{
        const resp = await fetch(RESERVE_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
          },
          body: JSON.stringify({ type, id: marker.dataset.id, start: chosen.value })
        });
        if(resp.ok){
          location.reload();
        }else{
          const d = await resp.text();
          err.textContent = d || "Could not reserve. Please retry.";
          err.classList.remove('d-none');
        }
      }catch(ex){
        err.textContent = "Network error.";
        err.classList.remove('d-none');
      }
    };
  }

  // --- Admin edit toggles ---
  // Staff can flip edit mode to drag markers and cycle status
  if (isAdmin && toggleBtn) {
    toggleBtn.addEventListener('click', () => {
      editMode = !editMode;
      toggleBtn.textContent = `Edit mode: ${editMode ? 'On' : 'Off'}`;
      map.querySelectorAll('.marker').forEach(m => m.classList.toggle('editing', editMode));
    });
  }

  // --- User click on marker (admin cycles; users open/reserve; guests login) ---
  // Routes click behavior to admin cycling or user reservation/login flow
  map.addEventListener('click', (e) => {
    if (editMode) return;
    const m = e.target.closest('.marker');
    if (!m) return;
    const status = m.dataset.status;

    if (isAdmin) {
      const type = m.dataset.type;
      const current = m.dataset.status;
      const order = ICONS[type].order;

      const next = order[(order.indexOf(current) + 1) % order.length];

      m.dataset.status = next;
      m.title = m.title.replace(/\(.+\)$/, `(${next.replace(/_/g,' ')})`);
      m.querySelector('img').src = ICONS[type].urls[next];

      showTooltip(`Status set to: ${next.replace(/_/g,' ')}`, e);

      fetch(STATUS_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": csrftoken },
        body: JSON.stringify({ id: m.dataset.id, type: type, status: next })
      }).then(r => {
        if (!r.ok) console.error("Status save failed:", r.status);
      }).catch(err => console.error(err));
      return;
    }

    if (status === "repair" || status === "out_of_order"){
      showTooltip("This spot is currently out of order.", e);
      return;
    }

    if (!isAuthenticated){
      showLoginModal(m.title || "this spot");
      return;
    }

    openReservationModal(m);
  });

  // --- Drag to move (admin edit mode) ---
  // Handles pointer drag to move markers and persist coordinates
  map.addEventListener('pointerdown', (e) => {
    if (!isAdmin || !editMode) return;
    const m = e.target.closest('.marker');
    if (!m) return;
    dragging = m;
    pointerId = e.pointerId;
    m.setPointerCapture(pointerId);
  });

  map.addEventListener('pointermove', (e) => {
    if (!dragging || e.pointerId !== pointerId) return;
    const rect = map.getBoundingClientRect();
    let x = ((e.clientX - rect.left) / rect.width) * 100;
    let y = ((e.clientY - rect.top)  / rect.height) * 100;
    x = Math.max(0, Math.min(100, x));
    y = Math.max(0, Math.min(100, y));
    dragging.style.setProperty('--x', x.toFixed(2));
    dragging.style.setProperty('--y', y.toFixed(2));
  });

  map.addEventListener('pointerup', (e) => {
    if (!dragging || e.pointerId !== pointerId) return;
    const x = dragging.style.getPropertyValue('--x').trim();
    const y = dragging.style.getPropertyValue('--y').trim();

    fetch(SAVE_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-CSRFToken": csrftoken },
      body: JSON.stringify({
        id: dragging.dataset.id,
        type: dragging.dataset.type,
        x, y
      })
    }).then(r => {
      if (!r.ok) console.error("Save failed:", r.status);
    }).catch(err => console.error(err));

    dragging.releasePointerCapture(pointerId);
    dragging = null; pointerId = null;
  });

  // --- Cancel active reservation banner ---
  // Banner button to cancel current reservation
  if (cancelBtn){
    // Pretty display of end time
    const endSpan = document.getElementById('active-res-end');
    if (endSpan && endSpan.dataset.end){
      const endTxt = new Date(endSpan.dataset.end);
      const opts = { hour: 'numeric', minute: '2-digit' };
      endSpan.textContent = endTxt.toLocaleTimeString([], opts);
    }
    cancelBtn.addEventListener('click', async () => {
      cancelBtn.disabled = true;
      try{
        const resp = await fetch(CANCEL_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json", "X-CSRFToken": csrftoken },
          body: JSON.stringify({})  // no payload needed
        });
        if (resp.ok){
          location.reload();
        } else {
          cancelBtn.disabled = false;
          showTooltip("Cancel failed. Please reload.", { clientX: 20, clientY: 20 });
        }
      }catch(ex){
        cancelBtn.disabled = false;
        showTooltip("Network error cancelling.", { clientX: 20, clientY: 20 });
      }
    });
  }

  // Auto-refresh every 60 seconds to reflect time-based status changes
  setInterval(() => { window.location.reload(); }, 60000);
})();
});
</script>
{% endblock %}
